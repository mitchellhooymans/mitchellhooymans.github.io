<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Hole Retention Estimator</title>
    <!-- Load Plotly.js for scientific graphing -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Load MathJax for LaTeX equations -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
        }
        h1 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 24px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .controls {
            background-color: #f1f3f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        label {
            font-weight: 600;
            font-size: 14px;
        }
        input[type=range] {
            width: 100%;
            cursor: pointer;
        }
        input[type=number] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 80px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            color: #0056b3;
        }
        .value-display {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            color: #0056b3;
        }
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            text-align: center;
            padding: 5px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2e7d32;
        }
        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #555;
            margin-top: 5px;
        }
        .stat-box.highlight {
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            border: 1px solid #a5d6a7;
        }
        .equation {
            text-align: center;
            margin: 10px 0 20px 0;
            padding: 10px;
            background: #fff;
            border: 1px solid #eee;
            font-size: 0.9em;
        }
        #plot {
            width: 100%;
            height: 450px;
        }
        .note {
            font-size: 0.85em;
            color: #666;
            margin-top: 20px;
            line-height: 1.5;
            background: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
        }
        @media (max-width: 700px) {
            .controls { grid-template-columns: 1fr; }
            .stats-panel { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>
        BH Retention Estimator
        <span style="font-size: 0.6em; color: #777; font-weight: normal;">(Hobbs Scaling)</span>
    </h1>
    
    <div class="equation">
        $$ P(v) = \sqrt{\frac{2}{\pi}} \frac{v^2}{\sigma_{bh}^3} \exp\left(-\frac{v^2}{2\sigma_{bh}^2}\right) $$
    </div>

    <div class="controls">
        <!-- Left Column: Physics Parameters -->
        <div class="control-group">
            <div class="control-row">
                <label>Scaling Fraction (σ<sub>BH</sub> / σ<sub>NS</sub>)</label>
                <span class="value-display" id="val-fraction">0.50</span>
            </div>
            <input type="range" id="slider-fraction" min="0.05" max="1.0" step="0.01" value="0.5">
            <small style="color: #666; margin-top: 5px;">Reference σ<sub>NS</sub> = 265 km/s</small>

            <div style="margin-top: 20px;">
                <label>Total BHs Formed (N<sub>initial</sub>)</label>
                <input type="number" id="input-total-bhs" value="1000" min="1" step="10">
                <small style="display:block; color: #666; margin-top: 5px;">Enter value from your IMF/CMC logs</small>
            </div>
        </div>

        <!-- Right Column: Cluster Environment -->
        <div class="control-group">
            <div class="control-row">
                <label>Escape Velocity (v<sub>esc</sub>)</label>
                <span class="value-display" id="val-vesc">50 km/s</span>
            </div>
            <input type="range" id="slider-vesc" min="10" max="200" step="1" value="50">
            <small style="color: #666; margin-top: 5px;">Velocity threshold for retention</small>
        </div>
    </div>

    <div class="stats-panel">
        <div class="stat-box">
            <div class="stat-value" id="disp-sigma-bh">132.5</div>
            <div class="stat-label">Current σ<sub>BH</sub> (km/s)</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="disp-peak-vel">187.4</div>
            <div class="stat-label">Peak Velocity (km/s)</div>
        </div>
        <div class="stat-box highlight">
            <div class="stat-value" id="disp-retention-pct">1.2%</div>
            <div class="stat-label">Retention %</div>
        </div>
        <div class="stat-box highlight">
            <div class="stat-value" id="disp-retention-count">12</div>
            <div class="stat-label">Est. BHs Retained</div>
        </div>
    </div>

    <div id="plot"></div>

    <div class="note">
        <strong>Interpretation:</strong> This tool estimates the <em>natal</em> retention fraction. It assumes all BHs receive a kick drawn from the scaled Maxwellian. It does not account for dynamical ejection (evaporation) over the cluster's lifetime, only the initial retention post-supernova. <br>
        <em>Note on Inputs:</em> "Total BHs Formed" should be the number of BH progenitors in your simulation that successfully collapse to a BH.
    </div>
</div>

<script>
    // --- Constants ---
    const SIGMA_NS = 265.0; // Hobbs et al. 2005
    const V_MAX = 1500;
    const POINTS = 1000;

    // --- Math Functions ---
    
    function maxwellian(v, sigma) {
        if (sigma <= 0) return 0;
        const term1 = Math.sqrt(2 / Math.PI);
        const term2 = (v * v) / Math.pow(sigma, 3);
        const term3 = Math.exp(-(v * v) / (2 * sigma * sigma));
        return term1 * term2 * term3;
    }

    function erf(x) {
        // Constants for approximation
        const a1 =  0.254829592;
        const a2 = -0.284496736;
        const a3 =  1.421413741;
        const a4 = -1.453152027;
        const a5 =  1.061405429;
        const p  =  0.3275911;

        let sign = 1;
        if (x < 0) sign = -1;
        x = Math.abs(x);

        const t = 1.0 / (1.0 + p * x);
        const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

        return sign * y;
    }

    function maxwellianCDF(v, sigma) {
        if (sigma <= 0) return 1.0;
        const x = v / (Math.sqrt(2) * sigma);
        const term1 = erf(x);
        const term2 = Math.sqrt(2 / Math.PI) * (v / sigma) * Math.exp(-(v * v) / (2 * sigma * sigma));
        return term1 - term2;
    }

    // --- Data Generation ---
    function generatePlotData(fraction, v_esc) {
        const sigma_bh = SIGMA_NS * fraction;
        
        const x_ns = [];
        const y_ns = [];
        const x_bh = [];
        const y_bh = [];
        const x_fill = [];
        const y_fill = [];

        const step = V_MAX / POINTS;

        for (let i = 0; i <= POINTS; i++) {
            const v = i * step;
            
            x_ns.push(v);
            y_ns.push(maxwellian(v, SIGMA_NS));

            x_bh.push(v);
            const prob_bh = maxwellian(v, sigma_bh);
            y_bh.push(prob_bh);

            if (v <= v_esc) {
                x_fill.push(v);
                y_fill.push(prob_bh);
            }
        }

        if (x_fill.length > 0 && x_fill[x_fill.length - 1] < v_esc) {
            x_fill.push(v_esc);
            y_fill.push(maxwellian(v_esc, sigma_bh));
        }
        x_fill.push(v_esc);
        y_fill.push(0);

        return { x_ns, y_ns, x_bh, y_bh, x_fill, y_fill, sigma_bh };
    }

    // --- Plot Initialization ---
    const layout = {
        margin: { t: 20, r: 20, b: 50, l: 60 },
        xaxis: { 
            title: 'Natal Kick Velocity (km/s)', 
            range: [0, 1000],
            fixedrange: true
        },
        yaxis: { 
            title: 'Probability Density P(v)', 
            range: [0, 0.008],
            fixedrange: true
        },
        showlegend: true,
        legend: { x: 0.65, y: 1 },
        shapes: []
    };

    const config = { responsive: true, displayModeBar: false };

    Plotly.newPlot('plot', [], layout, config);

    // --- Update Logic ---
    function updatePlot() {
        const fraction = parseFloat(document.getElementById('slider-fraction').value);
        const v_esc = parseFloat(document.getElementById('slider-vesc').value);
        const total_bhs = parseInt(document.getElementById('input-total-bhs').value) || 0;

        // Update Text Displays
        document.getElementById('val-fraction').textContent = fraction.toFixed(2);
        document.getElementById('val-vesc').textContent = v_esc + ' km/s';

        // Calculate Physics
        const data = generatePlotData(fraction, v_esc);
        const retention = maxwellianCDF(v_esc, data.sigma_bh);
        const peak_vel = Math.sqrt(2) * data.sigma_bh;
        const retained_count = Math.round(retention * total_bhs);

        // Update Stats Panel
        document.getElementById('disp-sigma-bh').textContent = data.sigma_bh.toFixed(1);
        document.getElementById('disp-peak-vel').textContent = peak_vel.toFixed(1);
        document.getElementById('disp-retention-pct').textContent = (retention * 100).toFixed(1) + '%';
        document.getElementById('disp-retention-count').textContent = retained_count;

        // Update Plot Traces
        const traceNS = {
            x: data.x_ns,
            y: data.y_ns,
            mode: 'lines',
            name: 'NS (Hobbs, σ=265)',
            line: { color: 'black', dash: 'dash', width: 2 }
        };

        const traceRetention = {
            x: data.x_fill,
            y: data.y_fill,
            mode: 'lines',
            fill: 'tozeroy',
            name: 'Retained',
            line: { width: 0, color: 'green' },
            fillcolor: 'rgba(46, 125, 50, 0.3)',
            hoverinfo: 'skip'
        };

        const traceBH = {
            x: data.x_bh,
            y: data.y_bh,
            mode: 'lines',
            name: `BH (Scaled, σ=${data.sigma_bh.toFixed(0)})`,
            line: { color: '#0056b3', width: 3 }
        };

        const shapes = [{
            type: 'line',
            x0: v_esc,
            y0: 0,
            x1: v_esc,
            y1: 0.02, // Extend high enough
            line: {
                color: 'green',
                width: 2,
                dash: 'dot'
            }
        }];

        // Dynamic Y-axis
        const peak_prob = maxwellian(peak_vel, data.sigma_bh);
        const new_layout = { 
            ...layout, 
            shapes: shapes,
            yaxis: { 
                ...layout.yaxis, 
                range: [0, Math.max(0.008, peak_prob * 1.1)] 
            }
        };

        Plotly.react('plot', [traceNS, traceRetention, traceBH], new_layout, config);
    }

    // --- Event Listeners ---
    document.getElementById('slider-fraction').addEventListener('input', updatePlot);
    document.getElementById('slider-vesc').addEventListener('input', updatePlot);
    document.getElementById('input-total-bhs').addEventListener('input', updatePlot);

    // Trigger initial update
    updatePlot();

</script>

</body>
</html>
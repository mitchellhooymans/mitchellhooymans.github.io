<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Knowledge Graph | Mitchell Hooymans</title>
    <meta name="description"
        content="An interactive knowledge graph mapping the key concepts in Mitchell Hooymans' astrophysics research — black holes, star clusters, gravitational waves, AGN, and more.">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../styles.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <!-- Graph data (avoids file:// CORS) -->
    <script src="../graph-data.js"></script>
    <script src="../js/stars.js"></script>

    <style>
        /* ============================================================
           Knowledge Graph Page Styles
           ============================================================ */

        /* Full-screen capable container */
        body.fullscreen-active {
            overflow: hidden;
        }

        .kg-page-hero {
            min-height: 28vh;
            padding-top: 120px;
            padding-bottom: var(--space-8);
            display: flex;
            align-items: flex-end;
            position: relative;
            overflow: hidden;
        }

        .kg-page-hero .container {
            position: relative;
            z-index: 1;
        }

        .kg-page-hero h1 {
            margin-bottom: var(--space-3);
        }

        .kg-page-hero p {
            color: var(--color-gray-500);
            max-width: 680px;
            margin: 0;
        }

        /* ---- Graph wrapper (fills viewport minus nav in fullscreen) ---- */
        .graph-section {
            padding: 0 0 var(--space-20);
        }

        .graph-container {
            position: relative;
            width: 100%;
            height: 72vh;
            min-height: 500px;
            background: rgba(9, 10, 15, 0.55);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-2xl);
            overflow: hidden;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.06);
            transition: border-radius 0.3s ease;
        }

        /* Ambient top glow */
        .graph-container::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: radial-gradient(ellipse 70% 50% at 50% 0%,
                    rgba(56, 189, 248, 0.05) 0%,
                    transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* ---- Fullscreen state ---- */
        .graph-container.is-fullscreen {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
            border: none;
        }

        #knowledge-graph-svg {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
        }

        /* ---- Tooltip ---- */
        .graph-tooltip {
            position: absolute;
            z-index: 100;
            pointer-events: none;
            background: rgba(9, 10, 23, 0.92);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            max-width: 280px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.18s ease;
        }

        .graph-tooltip.visible {
            opacity: 1;
        }

        .graph-tooltip .tooltip-title {
            font-family: var(--font-heading);
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--color-white);
            margin-bottom: 0.3rem;
            line-height: 1.3;
        }

        .graph-tooltip .tooltip-group {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.4rem;
        }

        .graph-tooltip .tooltip-desc {
            font-size: 0.79rem;
            color: var(--color-gray-600);
            line-height: 1.5;
            margin: 0;
        }

        .graph-tooltip .tooltip-edge-label {
            font-size: 0.8rem;
            color: var(--color-gray-600);
            font-style: italic;
            margin: 0;
        }

        /* ---- Legend ---- */
        .graph-legend {
            position: absolute;
            bottom: var(--space-4);
            left: var(--space-4);
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(9, 10, 23, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
        }

        .legend-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--color-gray-400);
            margin-bottom: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.73rem;
            color: var(--color-gray-500);
        }

        .legend-dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* ---- Control bar (top-right) ---- */
        .graph-controls {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-3);
        }

        /* Explicit / Inferred badge */
        .graph-inferred-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.72rem;
            color: var(--color-gray-500);
            background: rgba(9, 10, 23, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: var(--radius-lg);
            padding: var(--space-2) var(--space-3);
        }

        .graph-inferred-badge .dash-sample {
            width: 22px;
            height: 1.5px;
            background: repeating-linear-gradient(90deg,
                    rgba(148, 163, 184, 0.55) 0, rgba(148, 163, 184, 0.55) 4px,
                    transparent 4px, transparent 8px);
        }

        .graph-inferred-badge .solid-sample {
            width: 22px;
            height: 1.5px;
            background: rgba(148, 163, 184, 0.55);
        }

        /* Fullscreen button */
        .btn-fullscreen {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--color-gray-500);
            background: rgba(9, 10, 23, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--space-2) var(--space-3);
            cursor: pointer;
            transition: all 0.18s ease;
            font-family: var(--font-primary);
        }

        .btn-fullscreen:hover {
            background: rgba(56, 189, 248, 0.12);
            border-color: rgba(56, 189, 248, 0.3);
            color: var(--color-white);
        }

        /* ---- Drag hint ---- */
        .graph-hint {
            position: absolute;
            bottom: var(--space-4);
            right: var(--space-5);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.76rem;
            color: rgba(148, 163, 184, 0.65);
            pointer-events: none;
            transition: opacity 1s ease;
        }

        .graph-hint.hidden {
            opacity: 0;
        }

        /* ---- Back link ---- */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 7px;
            font-size: 0.88rem;
            color: var(--color-gray-500);
            margin-bottom: var(--space-6);
            transition: color 0.18s ease;
        }

        .back-link:hover {
            color: var(--color-white);
            text-shadow: none;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .graph-container {
                height: 75vh;
            }

            .graph-legend {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <div id="navbar-placeholder"></div>
    <script src="../js/navbar.js"></script>

    <!-- Page Hero -->
    <section class="kg-page-hero">
        <div class="container">
            <a href="research.html" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 5l-7 7 7 7" />
                </svg>
                Back to Research
            </a>
            <h1 class="animate-fade-in-up">Research Knowledge Graph</h1>
            <p class="animate-fade-in-up delay-100">
                An interactive map of the key concepts shaping my research.
                Drag nodes to explore &mdash; click a node to highlight its connections.
            </p>
        </div>
    </section>

    <!-- Graph Section -->
    <section class="graph-section">
        <div class="container">
            <div class="graph-container" id="graph-container">
                <svg id="knowledge-graph-svg"></svg>

                <!-- Tooltip -->
                <div class="graph-tooltip" id="graph-tooltip">
                    <div class="tooltip-title" id="tooltip-title"></div>
                    <div class="tooltip-group" id="tooltip-group"></div>
                    <p class="tooltip-desc" id="tooltip-desc"></p>
                    <p class="tooltip-edge-label" id="tooltip-edge"></p>
                </div>

                <!-- Top-right controls -->
                <div class="graph-controls">
                    <button class="btn-fullscreen" id="btn-fullscreen" aria-label="Toggle fullscreen">
                        <svg id="fs-icon-expand" xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 3H5a2 2 0 0 0-2 2v3" />
                            <path d="M21 8V5a2 2 0 0 0-2-2h-3" />
                            <path d="M3 16v3a2 2 0 0 0 2 2h3" />
                            <path d="M16 21h3a2 2 0 0 0 2-2v-3" />
                        </svg>
                        <svg id="fs-icon-compress" xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" style="display:none">
                            <path d="M8 3v3a2 2 0 0 1-2 2H3" />
                            <path d="M21 8h-3a2 2 0 0 1-2-2V3" />
                            <path d="M3 16h3a2 2 0 0 1 2 2v3" />
                            <path d="M16 21v-3a2 2 0 0 1 2-2h3" />
                        </svg>
                        <span id="fs-label">Fullscreen</span>
                    </button>

                    <div class="graph-inferred-badge">
                        <span class="solid-sample"></span><span>Explicit</span>
                        <span class="dash-sample"></span><span>Inferred</span>
                    </div>
                </div>

                <!-- Bottom-left: group legend -->
                <div class="graph-legend" id="graph-legend">
                    <div class="legend-title">Groups</div>
                </div>

                <!-- Bottom-right: drag hint -->
                <div class="graph-hint" id="graph-hint">
                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 11V6a2 2 0 0 0-4 0v5" />
                        <path d="M14 10V4a2 2 0 0 0-4 0v2" />
                        <path d="M10 10.5V6a2 2 0 0 0-4 0v8" />
                        <path d="M6 14a2 2 0 0 0-2 2v2a6 6 0 0 0 6 6h4a6 6 0 0 0 6-6V11" />
                    </svg>
                    Drag to explore
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <!-- JavaScript -->
    <script src="../js/footer.js"></script>
    <script src="../js/back-to-top.js"></script>
    <script src="../js/animations.js"></script>
    <script src="../js/stars.js"></script>
    <script>new Footer().init('../');</script>

    <!-- Knowledge Graph Script -->
    <script>
        (function () {
            /* ----------------------------------------------------------------
               Colour palette — cohesive with the cosmic dark theme
               ---------------------------------------------------------------- */
            const GROUP_COLOURS = {
                'Core Topic': '#38bdf8',  /* site cyan          */
                'Astrophysical Environments': '#818cf8',  /* indigo             */
                'Stellar Physics': '#f59e0b',  /* warm amber         */
                'Theoretical Frameworks': '#34d399',  /* emerald            */
                'Observational Astrophysics': '#e879f9',  /* violet / pulsar    */
                'Observational Instruments': '#fb923c',  /* orange             */
                'Computational Methods': '#a78bfa',  /* soft purple        */
                'AGN Physics': '#f472b6',  /* warm pink          */
            };

            const DEFAULT_COLOUR = '#94a3b8';
            const nodeColour = g => GROUP_COLOURS[g] || DEFAULT_COLOUR;

            /* ---- Load & render ---- */
            function loadAndRender() {
                if (window.GRAPH_DATA) {
                    initGraph(window.GRAPH_DATA);
                } else {
                    fetch('../graph-data.json')
                        .then(r => r.json())
                        .then(initGraph)
                        .catch(err => console.warn('Knowledge graph failed to load:', err));
                }
            }

            document.readyState === 'loading'
                ? document.addEventListener('DOMContentLoaded', loadAndRender)
                : loadAndRender();

            /* ---- Fullscreen toggle ---- */
            const fsBtn = document.getElementById('btn-fullscreen');
            const fsIconExp = document.getElementById('fs-icon-expand');
            const fsIconComp = document.getElementById('fs-icon-compress');
            const fsLabel = document.getElementById('fs-label');
            const graphCont = document.getElementById('graph-container');
            let isFullscreen = false;

            function enterFullscreen() {
                isFullscreen = true;
                graphCont.classList.add('is-fullscreen');
                document.body.classList.add('fullscreen-active');
                fsIconExp.style.display = 'none';
                fsIconComp.style.display = '';
                fsLabel.textContent = 'Exit';
                if (graphCont.requestFullscreen) graphCont.requestFullscreen().catch(() => { });
            }

            function exitFullscreen() {
                isFullscreen = false;
                graphCont.classList.remove('is-fullscreen');
                document.body.classList.remove('fullscreen-active');
                fsIconExp.style.display = '';
                fsIconComp.style.display = 'none';
                fsLabel.textContent = 'Fullscreen';
                if (document.exitFullscreen && document.fullscreenElement) document.exitFullscreen();
            }

            fsBtn.addEventListener('click', () => isFullscreen ? exitFullscreen() : enterFullscreen());

            // Also handle native ESC / fullscreen change events
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement && isFullscreen) exitFullscreen();
            });
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape' && isFullscreen) exitFullscreen();
            });

            /* ---- Graph initialisation ---- */
            function initGraph(rawData) {
                const data = JSON.parse(JSON.stringify(rawData));
                const container = document.getElementById('graph-container');
                const svg = d3.select('#knowledge-graph-svg');
                const tooltip = document.getElementById('graph-tooltip');
                const ttTitle = document.getElementById('tooltip-title');
                const ttGroup = document.getElementById('tooltip-group');
                const ttDesc = document.getElementById('tooltip-desc');
                const ttEdge = document.getElementById('tooltip-edge');

                let width = container.clientWidth;
                let height = container.clientHeight;

                svg.attr('viewBox', `0 0 ${width} ${height}`);

                /* ---- Defs ---- */
                const defs = svg.append('defs');
                defs.append('marker')
                    .attr('id', 'arrowhead')
                    .attr('viewBox', '-0 -4 8 8')
                    .attr('refX', 18).attr('refY', 0)
                    .attr('orient', 'auto')
                    .attr('markerWidth', 6).attr('markerHeight', 6)
                    .append('path')
                    .attr('d', 'M 0,-4 L 8,0 L 0,4')
                    .attr('fill', 'rgba(148,163,184,0.35)');

                /* ---- Layer groups ---- */
                const gLinks = svg.append('g').attr('class', 'links');
                const gNodes = svg.append('g').attr('class', 'nodes');

                /* ---- Node index ---- */
                const nodeById = Object.fromEntries(data.nodes.map(n => [n.id, n]));

                /* ---- Simulation ---- */
                const simulation = d3.forceSimulation(data.nodes)
                    .force('link', d3.forceLink(data.links).id(d => d.id).distance(140).strength(0.45))
                    .force('charge', d3.forceManyBody().strength(-350))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide(38))
                    .force('x', d3.forceX(width / 2).strength(0.035))
                    .force('y', d3.forceY(height / 2).strength(0.035));

                /* ---- Links ---- */
                const link = gLinks.selectAll('line')
                    .data(data.links).join('line')
                    .attr('stroke', 'rgba(148,163,184,0.25)')
                    .attr('stroke-width', 1.4)
                    .attr('stroke-dasharray', d => d.inferred ? '5,4' : null)
                    .attr('marker-end', 'url(#arrowhead)')
                    .style('cursor', 'pointer');

                /* ---- Nodes ---- */
                const node = gNodes.selectAll('g')
                    .data(data.nodes).join('g')
                    .attr('class', 'node-group')
                    .style('cursor', 'grab')
                    .call(drag(simulation));

                node.append('circle').attr('r', 18)
                    .attr('fill', d => nodeColour(d.group)).attr('opacity', 0.12);

                node.append('circle').attr('class', 'node-circle').attr('r', 11)
                    .attr('fill', d => nodeColour(d.group))
                    .attr('stroke', '#0b1121').attr('stroke-width', 2);

                node.append('text').attr('class', 'node-label')
                    .attr('dy', '0.35em').attr('x', 16)
                    .text(d => d.id)
                    .attr('fill', 'rgba(226,232,240,0.88)')
                    .attr('font-size', '11px')
                    .attr('font-family', 'Inter, sans-serif')
                    .style('pointer-events', 'none')
                    .style('user-select', 'none');

                /* ---- Tick ---- */
                simulation.on('tick', () => {
                    link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                    node.attr('transform', d => `translate(${d.x},${d.y})`);
                });

                /* ---- Highlight state ---- */
                let selectedId = null;

                function applyHighlight(id) {
                    selectedId = id;
                    if (!id) {
                        node.attr('opacity', 1);
                        link.attr('opacity', 1).attr('stroke', 'rgba(148,163,184,0.25)');
                        return;
                    }
                    const nbrs = new Set([id]);
                    data.links.forEach(l => {
                        const s = typeof l.source === 'object' ? l.source.id : l.source;
                        const t = typeof l.target === 'object' ? l.target.id : l.target;
                        if (s === id) nbrs.add(t);
                        if (t === id) nbrs.add(s);
                    });
                    node.attr('opacity', d => nbrs.has(d.id) ? 1 : 0.12);
                    link.attr('opacity', d => {
                        const s = typeof d.source === 'object' ? d.source.id : d.source;
                        const t = typeof d.target === 'object' ? d.target.id : d.target;
                        return (s === id || t === id) ? 1 : 0.05;
                    }).attr('stroke', d => {
                        const s = typeof d.source === 'object' ? d.source.id : d.source;
                        const t = typeof d.target === 'object' ? d.target.id : d.target;
                        if (s === id) return nodeColour((nodeById[t] || {}).group);
                        if (t === id) return nodeColour((nodeById[s] || {}).group);
                        return 'rgba(148,163,184,0.05)';
                    });
                }

                /* ---- Node events ---- */
                node
                    .on('click', function (event, d) {
                        event.stopPropagation();
                        applyHighlight(selectedId === d.id ? null : d.id);
                    })
                    .on('mouseover', function (event, d) {
                        ttTitle.textContent = d.id;
                        ttGroup.textContent = d.group;
                        ttGroup.style.color = nodeColour(d.group);
                        ttDesc.textContent = d.description || '';
                        ttEdge.textContent = '';
                        ttEdge.style.display = 'none';
                        ttDesc.style.display = 'block';
                        positionTooltip(event);
                        tooltip.classList.add('visible');
                        d3.select(this).select('.node-circle')
                            .attr('r', 13).attr('stroke-width', 3).attr('stroke', nodeColour(d.group));
                    })
                    .on('mousemove', positionTooltip)
                    .on('mouseout', function (event, d) {
                        tooltip.classList.remove('visible');
                        d3.select(this).select('.node-circle')
                            .attr('r', 11).attr('stroke-width', 2).attr('stroke', '#0b1121');
                    });

                /* ---- Edge events ---- */
                link
                    .on('mouseover', function (event, d) {
                        ttTitle.textContent = '';
                        ttGroup.textContent = '';
                        ttDesc.style.display = 'none';
                        ttEdge.textContent = d.label ? `"${d.label}"` : '';
                        ttEdge.style.display = d.label ? 'block' : 'none';
                        positionTooltip(event);
                        tooltip.classList.add('visible');
                        d3.select(this).attr('stroke', 'rgba(148,163,184,0.7)').attr('stroke-width', 2.4);
                    })
                    .on('mousemove', positionTooltip)
                    .on('mouseout', function () {
                        tooltip.classList.remove('visible');
                        d3.select(this).attr('stroke', 'rgba(148,163,184,0.25)').attr('stroke-width', 1.4);
                    });

                /* ---- Click-away clears selection ---- */
                svg.on('click', () => applyHighlight(null));

                /* ---- Tooltip position ---- */
                function positionTooltip(event) {
                    const rect = container.getBoundingClientRect();
                    let x = event.clientX - rect.left + 14;
                    let y = event.clientY - rect.top + 14;
                    const tw = tooltip.offsetWidth || 240;
                    const th = tooltip.offsetHeight || 80;
                    if (x + tw > width - 8) x = event.clientX - rect.left - tw - 14;
                    if (y + th > height - 8) y = event.clientY - rect.top - th - 14;
                    tooltip.style.left = `${x}px`;
                    tooltip.style.top = `${y}px`;
                }

                /* ---- Drag ---- */
                function drag(sim) {
                    return d3.drag()
                        .on('start', (e, d) => { if (!e.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                        .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
                        .on('end', (e, d) => { if (!e.active) sim.alphaTarget(0); d.fx = null; d.fy = null; });
                }

                /* ---- Build legend ---- */
                const legendEl = document.getElementById('graph-legend');
                [...new Set(data.nodes.map(n => n.group))].forEach(g => {
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `<span class="legend-dot" style="background:${nodeColour(g)};"></span><span>${g}</span>`;
                    legendEl.appendChild(item);
                });

                /* ---- Drag-hint fade ---- */
                const hint = document.getElementById('graph-hint');
                setTimeout(() => hint.classList.add('hidden'), 3000);

                /* ---- Responsive resize (incl. fullscreen changes) ---- */
                const ro = new ResizeObserver(() => {
                    width = container.clientWidth;
                    height = container.clientHeight;
                    svg.attr('viewBox', `0 0 ${width} ${height}`);
                    simulation
                        .force('center', d3.forceCenter(width / 2, height / 2))
                        .force('x', d3.forceX(width / 2).strength(0.035))
                        .force('y', d3.forceY(height / 2).strength(0.035))
                        .alpha(0.3).restart();
                });
                ro.observe(container);
            }
        })();
    </script>
</body>

</html>
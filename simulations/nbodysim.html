<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive N-Body Simulation | Mitchell Hooymans</title>
    <meta name="description"
        content="Explore gravitational dynamics with multiple bodies. Watch star clusters evolve, planets orbit, and chaos emerge.">
    <link rel="canonical" href="https://mitchellhooymans.com/simulations/nbodysim.html" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mitchellhooymans.com/simulations/nbodysim.html">
    <meta property="og:title" content="Interactive N-Body Simulation | Mitchell Hooymans">
    <meta property="og:description"
        content="Explore gravitational dynamics with multiple bodies. Watch star clusters evolve, planets orbit, and chaos emerge.">
    <meta property="og:image" content="https://mitchellhooymans.com/images/general/milkyway.jpg">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://mitchellhooymans.com/simulations/nbodysim.html">
    <meta name="twitter:title" content="Interactive N-Body Simulation | Mitchell Hooymans">
    <meta name="twitter:description"
        content="Explore gravitational dynamics with multiple bodies. Watch star clusters evolve, planets orbit, and chaos emerge.">
    <meta name="twitter:image" content="https://mitchellhooymans.com/images/general/milkyway.jpg">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../styles.css">
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon/apple-touch-icon.png">
    <link rel="manifest" href="../images/favicon/site.webmanifest">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        .content-section {
            max-width: 1100px;
            margin: 0 auto;
        }

        .simulation-wrapper {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-6);
        }

        @media (min-width: 950px) {
            .simulation-wrapper {
                grid-template-columns: 1fr 300px;
            }
        }

        .simulation-container {
            background: #000;
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            position: relative;
            width: 100%;
        }

        #simulationCanvas {
            display: block;
            width: 100%;
            height: 100%;
            aspect-ratio: 16/9;
            background: radial-gradient(ellipse at center, #0d1117 0%, #000 100%);
        }

        .sim-overlay {
            position: absolute;
            top: var(--space-3);
            left: var(--space-3);
            background: rgba(0, 0, 0, 0.8);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            color: #fff;
            font-size: 0.7rem;
            font-family: 'Courier New', monospace;
        }

        .sim-overlay div {
            margin-bottom: 2px;
        }

        .controls-panel {
            background: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            max-height: 650px;
            overflow-y: auto;
        }

        .controls-panel h3 {
            margin-bottom: var(--space-4);
            color: var(--color-primary);
            font-size: 1rem;
        }

        .control-section {
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .control-section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .control-section h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-gray-500);
            margin-bottom: var(--space-2);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: var(--space-2);
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: var(--color-gray-700);
            font-size: 0.8rem;
        }

        .control-value {
            font-weight: 600;
            color: var(--color-accent);
            font-size: 0.75rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--color-gray-300);
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            transition: background 0.2s;
        }

        .control-group input[type="range"]:hover {
            background: var(--color-gray-400);
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--color-accent);
            cursor: pointer;
        }

        .button-row {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .sim-btn {
            flex: 1;
            min-width: 65px;
            padding: var(--space-2) var(--space-2);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .sim-btn-primary {
            background: var(--color-accent);
            color: var(--color-white);
        }

        .sim-btn-primary:hover {
            background: #d4a853;
        }

        .sim-btn-secondary {
            background: var(--color-gray-200);
            color: var(--color-gray-700);
        }

        .sim-btn-secondary:hover {
            background: var(--color-gray-300);
        }

        .info-card {
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
            color: var(--color-white);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
        }

        .info-card h3 {
            color: var(--color-white);
            margin-bottom: var(--space-2);
            font-size: 1rem;
        }

        .info-card p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: var(--space-2);
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .info-card p:last-child {
            margin-bottom: 0;
        }

        .preset-btns {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-2);
        }

        .preset-btn {
            padding: var(--space-2);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            background: var(--color-white);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-align: center;
        }

        .preset-btn:hover,
        .preset-btn.active {
            border-color: var(--color-accent);
            background: var(--color-accent);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 0.8rem;
            color: var(--color-gray-700);
            cursor: pointer;
        }

        .placement-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            padding: var(--space-4);
            cursor: crosshair;
            z-index: 10;
        }

        .placement-overlay.hidden {
            display: none;
        }

        .placement-overlay i {
            font-size: 2rem;
            margin-bottom: var(--space-3);
            color: var(--color-accent);
        }

        .placement-count {
            margin-top: var(--space-2);
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .placement-hint {
            margin-top: var(--space-3);
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .unit-label {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-left: 2px;
        }

        .mass-input-group {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        .mass-input {
            flex: 1;
            padding: var(--space-2);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-gray-700);
            background: var(--color-white);
            min-width: 0;
        }

        .mass-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2);
        }

        .unit-select {
            padding: var(--space-2);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-gray-600);
            background: var(--color-white);
            cursor: pointer;
            min-width: 65px;
        }

        .unit-select:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .control-group.mass-control label {
            margin-bottom: var(--space-1);
        }

        /* Full Browser Mode */
        body.full-browser {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        body.full-browser .nav,
        body.full-browser .page-header,
        body.full-browser .footer,
        body.full-browser .back-link,
        body.full-browser .info-card {
            display: none !important;
        }

        body.full-browser .section {
            padding: 0 !important;
            margin: 0 !important;
        }

        body.full-browser .container {
            max-width: none !important;
            width: 100vw !important;
            height: 100vh !important;
            padding: 0 !important;
        }

        body.full-browser .content-section {
            max-width: none !important;
            margin: 0 !important;
            height: 100% !important;
        }

        body.full-browser .simulation-wrapper {
            grid-template-columns: 1fr !important;
            height: 100% !important;
            gap: 0 !important;
        }

        body.full-browser .simulation-container {
            border-radius: 0 !important;
            height: 100% !important;
        }

        body.full-browser #simulationCanvas {
            aspect-ratio: auto !important;
            height: 100% !important;
        }

        body.full-browser .controls-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: var(--shadow-2xl);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        body.full-browser .sim-overlay {
            top: 20px;
            left: 20px;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="nav" id="nav">
        <div class="nav-content">
            <a href="../" class="nav-brand">
                <span>Mitchell</span>Hooymans
            </a>
            <ul class="nav-links">
                <li><a href="../">Home</a></li>
                <li><a href="../pages/about.html">About</a></li>
                <li><a href="../pages/resources.html">Resources</a></li>
                <li><a href="../pages/blog.html">Blog</a></li>
                <li><a href="../pages/photography.html">Photography</a></li>
                <li><a href="../pages/cv.html">CV</a></li>
                <li><a href="../pages/contact.html">Contact</a></li>
            </ul>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="../">Home</a>
        <a href="../pages/about.html">About</a>
        <a href="../pages/resources.html">Resources</a>
        <a href="../pages/blog.html">Blog</a>
        <a href="../pages/photography.html">Photography</a>
        <a href="../pages/cv.html">CV</a>
        <a href="../pages/contact.html">Contact</a>
    </div>

    <!-- Page Header -->
    <header class="page-header">
        <div class="container">
            <h1>N-Body Simulation</h1>
            <p>Many-body gravitational dynamics</p>
        </div>
    </header>

    <!-- Main Content -->
    <section class="section">
        <div class="container">
            <a href="../pages/resources.html" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Resources
            </a>

            <div class="content-section">
                <!-- Info Card -->
                <div class="info-card">
                    <h3><i class="fas fa-globe"></i> The N-Body Problem</h3>
                    <p>
                        Simulate gravitational interactions between many bodies. Watch star clusters form,
                        planets orbit a central star, or observe chaotic encounters. The computational
                        complexity grows as O(N²), so we keep N reasonable for smooth animation.
                    </p>
                    <p style="font-size: 0.85rem; opacity: 0.9;">
                        <strong>Units:</strong> Central mass in <em>solar masses</em> (M☉). Particle mass in <em>Earth
                            masses</em> (M⊕).
                        Spread in <em>astronomical units</em> (AU).
                    </p>
                </div>

                <div class="simulation-wrapper">
                    <!-- Simulation Canvas -->
                    <div class="simulation-container">
                        <canvas id="simulationCanvas"></canvas>
                        <div class="sim-overlay">
                            <div>Bodies: <span id="bodyCount">0</span></div>
                            <div>Time: <span id="timeDisplay">0.00</span> <span class="unit-label"
                                    id="timeUnitLabel">years</span></div>
                            <div>FPS: <span id="fpsDisplay">0</span></div>
                        </div>

                    </div>

                    <!-- Controls Panel -->
                    <div class="controls-panel">
                        <h3><i class="fas fa-sliders-h"></i> Controls</h3>

                        <div class="control-section">
                            <h4>Presets</h4>
                            <div class="preset-btns">
                                <button class="preset-btn" data-preset="solar">Solar System</button>
                                <button class="preset-btn" data-preset="cluster">Star Cluster</button>
                                <button class="preset-btn" data-preset="ring">Ring Galaxy</button>
                                <button class="preset-btn" data-preset="binary">Binary + Planets</button>
                                <button class="preset-btn" data-preset="collision">Collision</button>
                                <button class="preset-btn" data-preset="random">Random</button>

                            </div>
                        </div>

                        <div class="control-section">
                            <h4>Particles</h4>
                            <div class="control-group" id="nControl">
                                <label>Number of Bodies <span class="control-value" id="nValue">15</span></label>
                                <input type="range" id="nSlider" min="3" max="50" step="1" value="15">
                            </div>
                            <div class="control-group mass-control" id="centralMassControl">
                                <label id="centralMassLabel">Central Mass</label>
                                <div class="mass-input-group">
                                    <input type="number" id="centralInput" class="mass-input" value="1" min="0"
                                        step="any">
                                    <select id="centralUnit" class="unit-select">
                                        <option value="solar" selected>M☉</option>
                                        <option value="earth">M⊕</option>
                                    </select>
                                </div>
                            </div>
                            <div class="control-group mass-control" id="particleMassControl">
                                <label>Particle Mass</label>
                                <div class="mass-input-group">
                                    <input type="number" id="massInput" class="mass-input" value="1" min="0" step="any">
                                    <select id="massUnit" class="unit-select">
                                        <option value="solar">M☉</option>
                                        <option value="earth" selected>M⊕</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Planet Masses Container -->
                            <div id="planetControls" class="hidden">
                                <h4 style="margin-bottom: 10px;">Planet Masses</h4>
                                <div id="planetInputs"></div>
                            </div>
                        </div>

                        <div class="control-section">
                            <h4>Initial Conditions</h4>
                            <div class="control-group" id="spreadControl">
                                <label>Size/Spread <span class="control-value" id="spreadValue">1.5</span> <span
                                        class="unit-label" id="spreadUnitLabel">AU</span></label>
                                <input type="range" id="spreadSlider" min="0.5" max="3" step="0.1" value="1.5">
                            </div>
                        </div>

                        <div class="control-section">
                            <h4>Display</h4>
                            <div class="control-group">
                                <label>Speed <span class="control-value" id="speedValue">1.0</span>x</label>
                                <input type="range" id="speedSlider" min="0.25" max="4" step="0.25" value="1">
                            </div>
                            <div class="control-group">
                                <label>Trail Length <span class="control-value" id="trailValue">100</span></label>
                                <input type="range" id="trailSlider" min="0" max="300" step="25" value="100">
                            </div>
                            <div class="control-group">
                                <label>Zoom <span class="control-value" id="zoomValue">1.0</span>x</label>
                                <input type="range" id="zoomSlider" min="0.01" max="2" step="0.01" value="1">
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="showVectors">
                                <label for="showVectors">Show velocity vectors</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="showCoM">
                                <label for="showCoM">Show centre of mass</label>
                            </div>
                        </div>

                        <div class="button-row">
                            <button class="sim-btn sim-btn-primary" id="playPauseBtn">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button class="sim-btn sim-btn-secondary" id="resetBtn">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                        <button class="sim-btn sim-btn-secondary" id="fullBrowserBtn"
                            style="width: 100%; margin-top: var(--space-3);">
                            <i class="fas fa-expand"></i> Full Browser
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div>
                    <div class="footer-brand">Mitchell Hooymans</div>
                    <p class="footer-tagline">Astrophysicist & STEM Communicator</p>
                </div>
                <div class="social-links">
                    <a href="https://www.linkedin.com/in/mitchell-hooymans/" class="social-link" aria-label="LinkedIn"
                        target="_blank">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a href="https://github.com/mitchellhooymans" class="social-link" aria-label="GitHub"
                        target="_blank">
                        <i class="fab fa-github"></i>
                    </a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Mitchell Hooymans. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // ========================================
        // Navigation
        // ========================================
        const nav = document.getElementById('nav');
        window.addEventListener('scroll', () => {
            nav.classList.toggle('scrolled', window.scrollY > 50);
        });

        const navToggle = document.getElementById('navToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        navToggle.addEventListener('click', () => mobileMenu.classList.toggle('open'));
        mobileMenu.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => mobileMenu.classList.remove('open'));
        });

        // ========================================
        // Canvas Setup
        // ========================================
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');

        function setupCanvas() {
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.resetTransform();
            ctx.scale(dpr, dpr);
        }
        setupCanvas();
        window.addEventListener('resize', setupCanvas);

        // View State (Panning)
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        // Pan Event Listeners
        canvas.addEventListener('mousedown', (e) => {
            if (isCustomMode) return;
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;
            panX += dx;
            panY += dy;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            render();
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.style.cursor = isCustomMode ? 'crosshair' : 'grab';
        });

        canvas.addEventListener('dblclick', () => {
            if (isCustomMode) return;
            panX = 0;
            panY = 0;
            render();
        });

        // Initialize cursor
        canvas.style.cursor = 'grab';

        // Full Browser Logic
        document.getElementById('fullBrowserBtn').addEventListener('click', function () {
            document.body.classList.toggle('full-browser');
            const icon = this.querySelector('i');
            const text = this.lastChild;

            if (document.body.classList.contains('full-browser')) {
                icon.className = 'fas fa-compress';
                text.textContent = ' Exit Full';
            } else {
                icon.className = 'fas fa-expand';
                text.textContent = ' Full Browser';
            }

            setTimeout(setupCanvas, 50);
        });

        // ========================================
        // State
        // ========================================
        let isPlaying = true;
        let simTime = 0;
        let fps = 0;
        let frameCount = 0;
        let lastFpsTime = 0;

        let N = 15;
        let centralMass = 50;
        let particleMass = 1;
        let spread = 1.5; // AU
        let initialVelFactor = 1;
        let timeScale = 1;
        let trailLength = 100;
        let zoom = 1;
        let showVectors = false;
        let showCoM = false;

        let bodies = [];
        let trails = [];
        let currentPreset = 'solar';

        // Custom placement mode
        let isCustomMode = false;
        let customBodies = [];
        const placementOverlay = document.getElementById('placementOverlay');

        // Scale: pixels per AU
        const PIXELS_PER_AU = 100;

        const G = 500;

        // Color palette for bodies
        const colors = [
            '#fbbf24', '#60a5fa', '#34d399', '#f472b6', '#a78bfa',
            '#fb923c', '#4ade80', '#38bdf8', '#e879f9', '#facc15',
            '#22d3d8', '#f87171', '#a3e635', '#818cf8', '#fb7185'
        ];

        // Solar System Configuration (modifiable)
        const solarConfig = [
            { name: 'Mercury', r: 0.39, m: 1.66e-7, radius: 3, color: '#A5A5A5' },
            { name: 'Venus', r: 0.72, m: 2.45e-6, radius: 4, color: '#E3BB76' },
            { name: 'Earth', r: 1.00, m: 3.00e-6, radius: 4, color: '#22A6B3' },
            { name: 'Mars', r: 1.52, m: 3.23e-7, radius: 3, color: '#EB4C42' },
            { name: 'Jupiter', r: 5.20, m: 9.55e-4, radius: 10, color: '#D97706' },
            { name: 'Saturn', r: 9.54, m: 2.86e-4, radius: 9, color: '#F59E0B' },
            { name: 'Uranus', r: 19.2, m: 4.36e-5, radius: 6, color: '#67E8F9' },
            { name: 'Neptune', r: 30.1, m: 5.15e-5, radius: 6, color: '#3B82F6' }
        ];

        // ========================================
        // Preset Configurations (with display values and units)
        // centralMassType: 'star' = central star, 'binary' = star mass for binary, 'none' = not used
        // ========================================
        const presetsConfig = {
            'solar': {
                n: 8,
                central: 1, centralUnit: 'solar',
                mass: 1, massUnit: 'earth',
                spread: 1.0, distUnit: 'AU',
                vel: 1.0, timeUnit: 'years',
                zoom: 0.08, // Zoom out to see Neptune
                centralMassType: 'star'
            },
            'cluster': {
                n: 100,
                mass: 0.01, massUnit: 'solar',
                spread: 2.0, distUnit: 'pc',
                vel: 1.0, timeUnit: 'Myr',
                centralMassType: 'none'
            },
            'ring': {
                n: 50,
                central: 1, centralUnit: 'solar',
                mass: 1, massUnit: 'earth',
                spread: 1.2, distUnit: 'kpc',
                vel: 1.0, timeUnit: 'Myr',
                centralMassType: 'star'
            },
            'binary': {
                n: 20,
                central: 1, centralUnit: 'solar',
                mass: 1, massUnit: 'earth',
                spread: 1.5, distUnit: 'AU',
                vel: 1.0, timeUnit: 'years',
                centralMassType: 'binary'
            },
            'collision': {
                n: 100,
                mass: 1, massUnit: 'solar',
                spread: 2.0, distUnit: 'pc',
                vel: 0.8, timeUnit: 'Myr',
                centralMassType: 'none'
            },
            'random': {
                n: 50,
                mass: 1, massUnit: 'solar',
                spread: 2.0, distUnit: 'AU',
                vel: 1.0, timeUnit: 'years',
                centralMassType: 'none'
            }
        };

        // Update central mass control visibility and label based on preset
        function updateCentralMassControl(presetName) {
            const preset = presetsConfig[presetName];
            const controlEl = document.getElementById('centralMassControl');
            const labelEl = document.getElementById('centralMassLabel');

            if (preset.centralMassType === 'none') {
                controlEl.style.display = 'none';
            } else {
                controlEl.style.display = '';
                if (preset.centralMassType === 'binary') {
                    labelEl.textContent = 'Star Mass (each)';
                } else {
                    labelEl.textContent = 'Central Mass';
                }
            }
        }

        // ========================================
        // Unit Conversion
        // ========================================
        const UNIT_TO_SOLAR = {
            'solar': 1,
            'earth': 1 / 332946
        };

        const SOLAR_TO_UNIT = {
            'solar': 1,
            'earth': 332946
        };

        // Internal mass scale (keeps simulation stable)
        const INTERNAL_MASS_SCALE = 100;

        function displayToInternal(value, unit) {
            return value * UNIT_TO_SOLAR[unit] * INTERNAL_MASS_SCALE;
        }

        function convertUnits(value, fromUnit, toUnit) {
            const solarMass = value * UNIT_TO_SOLAR[fromUnit];
            return solarMass * SOLAR_TO_UNIT[toUnit];
        }

        // ========================================
        // Initialization
        // ========================================

        // Helper functions moved to global scope
        function toggleControls(presetName) {
            const spreadControl = document.getElementById('spreadControl');
            const particleMassControl = document.getElementById('particleMassControl');
            const nControl = document.getElementById('nControl');
            const planetControls = document.getElementById('planetControls');
            const centralMassControl = document.getElementById('centralMassControl');
            const p = presetsConfig[presetName];

            // Central Mass
            if (centralMassControl) {
                if (p.centralMassType !== 'none') {
                    centralMassControl.classList.remove('hidden');
                    document.getElementById('centralMassLabel').textContent =
                        p.centralMassType === 'binary' ? 'Star Mass' : 'Central Mass';
                } else {
                    centralMassControl.classList.add('hidden');
                }
            }

            const searchParams = new URLSearchParams(window.location.search);
            const isSolar = presetName === 'solar';

            if (spreadControl) spreadControl.classList.toggle('hidden', isSolar);
            if (particleMassControl) particleMassControl.classList.toggle('hidden', isSolar);
            if (nControl) nControl.classList.toggle('hidden', isSolar);

            if (planetControls) {
                planetControls.classList.toggle('hidden', !isSolar);
                if (isSolar) setupPlanetControls();
            }
        }

        // Unit conversion helpers
        function convertMass(val, fromUnit, toUnit) {
            if (fromUnit === toUnit) return val;
            // Base is Solar
            const solar = fromUnit === 'solar' ? val : val / 332946;
            return toUnit === 'solar' ? solar : solar * 332946;
        }

        function toPlanetDisplay(solarMass, unit) {
            // Redundant but keeping for safety if referenced, actually used in setupPlanetControls?
            // setupPlanetControls uses convertMass. 
            // previous implementation used toPlanetDisplay?
            // In view 799, setupPlanetControls uses convertMass at line 875.
            // But let's check input value setting.
            // Line 875: input.value = convertMass(p.m, 'solar', 'earth').toFixed(4);
            // So we don't need toPlanetDisplay.
            return convertMass(solarMass, 'solar', unit).toFixed(4);
        }

        let currentPlanetUnit = 'earth';

        // One-time listener for global unit toggle
        const planetMassUnitSelect = document.getElementById('planetMassUnit');
        if (planetMassUnitSelect) {
            planetMassUnitSelect.addEventListener('change', (e) => {
                currentPlanetUnit = e.target.value;
                setupPlanetControls(true); // Force redraw
            });
        }

        function setupPlanetControls(force = false) {
            const container = document.getElementById('planetInputs');
            if (!container || (container.children.length > 0 && !force)) return;

            container.innerHTML = '';

            solarConfig.forEach((p, i) => {
                const row = document.createElement('div');
                // Removed 'control-group' class to avoid column layout conflict
                row.className = 'sm-row';
                row.style.marginBottom = '8px';
                row.style.display = 'flex';
                row.style.flexDirection = 'row'; // Explicitly force row
                row.style.alignItems = 'center';
                row.style.justifyContent = 'space-between'; // Spread out
                row.style.gap = '5px';

                const label = document.createElement('label');
                label.textContent = p.name;
                label.style.width = '70px';
                label.style.flexShrink = '0';

                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'mass-input';
                input.step = 'any';
                input.style.width = '80px';
                input.style.flexGrow = '1';

                const select = document.createElement('select');
                select.className = 'unit-select';
                select.style.width = '60px';
                select.innerHTML = `
                    <option value="earth" selected>M⊕</option>
                    <option value="solar">M☉</option>
                `;

                // Initial Value (Earth default for row?) No, use currentPlanetUnit?
                // The prompt asked for "Dropdown for EACH planet".
                // In my prev implementation (View 799), I added a SELECT to each row.
                // But I ALSO had a global logic `currentPlanetUnit`?
                // Line 850: `document.getElementById('planetMassUnit')...`
                // Wait, user asked "The simulation should start with... Planet Masses... each with their own input and unit dropdown."
                // My global dropdown `planetMassUnit` (Line 504) acts as a default?
                // Or did I confuse the global one with per-row?
                // The implementation in View 799 adds a per-row select (Line 866).
                // AND there is a global `planetMassUnit` (Line 850 listener).
                // What does the global one do? `setupPlanetControls(true)`.
                // It resets ALL rows to the global setting?
                // If user wants per-planet, the global one is a convenience "Set All"?
                // That's fine.
                // But for individual control, the per-row select handles it (Line 878).
                // "Input value depends on convertMass(p.m, 'solar', select.value)".
                // So per-row is working.

                // Set initial row unit to Global default?
                // select.value is 'earth' by default innerHTML.
                // If I want to respect global `currentPlanetUnit`, I should set `select.value = currentPlanetUnit`.
                select.value = currentPlanetUnit;

                input.value = convertMass(p.m, 'solar', currentPlanetUnit).toFixed(4);

                select.addEventListener('change', () => {
                    const newVal = convertMass(p.m, 'solar', select.value);
                    input.value = select.value === 'earth' ? newVal.toFixed(4) : newVal.toPrecision(4);
                });

                input.addEventListener('change', () => {
                    const val = parseFloat(input.value) || 0;
                    solarConfig[i].m = convertMass(val, select.value, 'solar');
                    initSimulation('solar');
                });

                row.appendChild(label);
                row.appendChild(input);
                row.appendChild(select);
                container.appendChild(row);
            });
        }

        function initSimulation(presetName) {
            // If switching preset, update controls
            if (presetName && presetsConfig[presetName]) {
                currentPreset = presetName;

                // Highlight active button
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.preset === presetName);
                });

                const p = presetsConfig[presetName];

                document.getElementById('nSlider').value = p.n;

                // Only set central mass for presets that use it
                if (p.centralMassType !== 'none' && p.central !== undefined) {
                    document.getElementById('centralInput').value = p.central;
                    document.getElementById('centralUnit').value = p.centralUnit;
                    document.getElementById('centralUnit').dataset.prevUnit = p.centralUnit;
                }

                document.getElementById('massInput').value = p.mass;
                document.getElementById('massUnit').value = p.massUnit;
                document.getElementById('massUnit').dataset.prevUnit = p.massUnit;
                document.getElementById('spreadSlider').value = p.spread;
                initialVelFactor = p.vel;

                if (p.zoom) {
                    zoom = p.zoom;
                    document.getElementById('zoomSlider').value = zoom;
                }

                // Update label text
                document.getElementById('spreadUnitLabel').textContent = p.distUnit;
                document.getElementById('timeUnitLabel').textContent = p.timeUnit;

                // Update controls visibility
                toggleControls(presetName);

                // Update global vars
                readControls();
            }

            // Functions moved to global scope


            // Fallback if just called without presetName (e.g. Reset button)
            const W = canvas.getBoundingClientRect().width;
            const H = canvas.getBoundingClientRect().height;

            bodies = [];
            trails = [];

            switch (currentPreset) {
                case 'solar':
                    initSolarSystem(W, H);
                    break;
                case 'cluster':
                    initCluster(W, H);
                    break;
                case 'ring':
                    initRing(W, H);
                    break;
                case 'binary':
                    initBinarySystem(W, H);
                    break;
                case 'collision':
                    initCollision(W, H);
                    break;
                case 'random':
                default:
                    initRandom(W, H);
            }

            simTime = 0;
            document.getElementById('bodyCount').textContent = bodies.length;
        }

        function initSolarSystem(W, H) {
            // Use global solarConfig

            // Central star (Sun)
            bodies.push({
                x: 0, y: 0,
                vx: 0, vy: 0,
                mass: centralMass,
                radius: 15,
                color: '#fcd34d',
                isStar: true
            });
            trails.push([]);

            // Create Planets
            solarConfig.forEach(p => {
                const rPx = p.r * PIXELS_PER_AU;
                const angle = Math.random() * Math.PI * 2;

                // Calculate mass
                const simMass = p.m * centralMass;

                // Circular orbital velocity
                const orbitalV = Math.sqrt(G * centralMass / rPx);

                bodies.push({
                    x: rPx * Math.cos(angle),
                    y: rPx * Math.sin(angle),
                    vx: -orbitalV * Math.sin(angle),
                    vy: orbitalV * Math.cos(angle),
                    mass: simMass,
                    radius: p.radius,
                    color: p.color
                });
                trails.push([]);
            });

            // Update N
            N = bodies.length;
            document.getElementById('nSlider').value = N;
            document.getElementById('nValue').textContent = N;
        }

        function initCluster(W, H) {
            const spreadPx = spread * PIXELS_PER_AU;

            // Calculate total mass for Virial theorem estimation
            // V_virial ≈ sqrt(G * M_total / R)
            // Using a simpler approximation for stable cluster
            const totalMass = N * particleMass;
            const virialV = Math.sqrt(G * totalMass / spreadPx) * initialVelFactor;

            for (let i = 0; i < N; i++) {
                const angle = Math.random() * Math.PI * 2;
                // Distributed radius (denser in center)
                const r = spreadPx * Math.sqrt(Math.random());
                const v = virialV * (0.8 + Math.random() * 0.4); // Randomize around virial velocity
                const vAngle = Math.random() * Math.PI * 2;

                bodies.push({
                    x: r * Math.cos(angle),
                    y: r * Math.sin(angle),
                    vx: v * Math.cos(vAngle),
                    vy: v * Math.sin(vAngle),
                    mass: particleMass * (0.5 + Math.random()),
                    radius: 5,
                    color: colors[i % colors.length]
                });
                trails.push([]);
            }
        }

        function initRing(W, H) {
            const spreadPx = spread * PIXELS_PER_AU;

            // Central mass
            bodies.push({
                x: 0, y: 0,
                vx: 0, vy: 0,
                mass: centralMass,
                radius: 15,
                color: '#fcd34d',
                isStar: true
            });
            trails.push([]);

            // Ring of particles
            for (let i = 0; i < N - 1; i++) {
                const angle = (i / (N - 1)) * Math.PI * 2;
                const r = spreadPx;
                // Circular velocity
                const orbitalV = Math.sqrt(G * centralMass / r) * initialVelFactor;

                bodies.push({
                    x: r * Math.cos(angle),
                    y: r * Math.sin(angle),
                    vx: -orbitalV * Math.sin(angle),
                    vy: orbitalV * Math.cos(angle),
                    mass: particleMass * 0.1,
                    radius: 2,
                    color: colors[i % colors.length]
                });
                trails.push([]);
            }
        }

        function initBinarySystem(W, H) {
            // Binary stars
            const starMass = centralMass; // Use slider value for each star
            const binaryDist = 60;
            // Velocity for circular binary orbit
            const binaryV = Math.sqrt(G * starMass / (2 * binaryDist)) * initialVelFactor;

            bodies.push({
                x: -binaryDist / 2, y: 0,
                vx: 0, vy: -binaryV,
                mass: starMass,
                radius: 12,
                color: '#fcd34d',
                isStar: true
            });
            trails.push([]);

            bodies.push({
                x: binaryDist / 2, y: 0,
                vx: 0, vy: binaryV,
                mass: starMass,
                radius: 12,
                color: '#fb923c',
                isStar: true
            });
            trails.push([]);

            // Circumbinary planets (must be > 2-3x binary separation)
            for (let i = 0; i < N - 2; i++) {
                const r = 120 + i * 25; // Start far out
                const angle = Math.random() * Math.PI * 2;
                // Approximate central mass as 2M
                const orbitalV = Math.sqrt(G * (2 * starMass) / r) * initialVelFactor;

                bodies.push({
                    x: r * Math.cos(angle),
                    y: r * Math.sin(angle),
                    vx: -orbitalV * Math.sin(angle),
                    vy: orbitalV * Math.cos(angle),
                    mass: particleMass,
                    radius: 4,
                    color: colors[i % colors.length]
                });
                trails.push([]);
            }
        }

        function initCollision(W, H) {
            const spreadPx = spread * PIXELS_PER_AU;

            // Two clusters approaching each other
            const clusterSize = Math.floor(N / 2);

            for (let i = 0; i < clusterSize; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * 60;

                bodies.push({
                    x: -spreadPx + r * Math.cos(angle),
                    y: r * Math.sin(angle),
                    vx: 0.8 * initialVelFactor,
                    vy: (Math.random() - 0.5) * 0.2,
                    mass: particleMass,
                    radius: 5,
                    color: colors[i % 5]
                });
                trails.push([]);
            }

            for (let i = 0; i < N - clusterSize; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * 60;

                bodies.push({
                    x: spreadPx + r * Math.cos(angle),
                    y: r * Math.sin(angle),
                    vx: -0.8 * initialVelFactor,
                    vy: (Math.random() - 0.5) * 0.2,
                    mass: particleMass,
                    radius: 5,
                    color: colors[(i + 5) % colors.length]
                });
                trails.push([]);
            }
        }

        function initRandom(W, H) {
            const spreadPx = spread * PIXELS_PER_AU;

            for (let i = 0; i < N; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * spreadPx;
                const v = Math.random() * 0.8 * initialVelFactor;
                const vAngle = Math.random() * Math.PI * 2;

                bodies.push({
                    x: r * Math.cos(angle),
                    y: r * Math.sin(angle),
                    vx: v * Math.cos(vAngle),
                    vy: v * Math.sin(vAngle),
                    mass: particleMass * (0.3 + Math.random() * 1.5),
                    radius: 5,
                    color: colors[i % colors.length]
                });
                trails.push([]);
            }
        }

        // ========================================
        // Physics
        // ========================================
        function updatePhysics(dt) {
            const n = bodies.length;

            // Compute initial accelerations
            const acc = bodies.map(() => ({ ax: 0, ay: 0 }));

            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    const dx = bodies[j].x - bodies[i].x;
                    const dy = bodies[j].y - bodies[i].y;
                    const distSq = dx * dx + dy * dy;
                    const dist = Math.sqrt(distSq);

                    // Softening to prevent singularities
                    const softening = (bodies[i].radius + bodies[j].radius) * 0.5;
                    const softDistSq = distSq + softening * softening;

                    const forceMag = G * bodies[i].mass * bodies[j].mass / softDistSq;

                    const fx = forceMag * dx / dist;
                    const fy = forceMag * dy / dist;

                    acc[i].ax += fx / bodies[i].mass;
                    acc[i].ay += fy / bodies[i].mass;
                    acc[j].ax -= fx / bodies[j].mass;
                    acc[j].ay -= fy / bodies[j].mass;
                }
            }

            // Velocity Verlet: half-step velocity + full position update
            for (let i = 0; i < n; i++) {
                bodies[i].vx += acc[i].ax * dt / 2;
                bodies[i].vy += acc[i].ay * dt / 2;
                bodies[i].x += bodies[i].vx * dt;
                bodies[i].y += bodies[i].vy * dt;
            }

            // Recompute accelerations at new positions
            const acc2 = bodies.map(() => ({ ax: 0, ay: 0 }));
            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    const dx = bodies[j].x - bodies[i].x;
                    const dy = bodies[j].y - bodies[i].y;
                    const distSq = dx * dx + dy * dy;
                    const dist = Math.sqrt(distSq);

                    const softening = (bodies[i].radius + bodies[j].radius) * 0.5;
                    const softDistSq = distSq + softening * softening;

                    const forceMag = G * bodies[i].mass * bodies[j].mass / softDistSq;

                    const fx = forceMag * dx / dist;
                    const fy = forceMag * dy / dist;

                    acc2[i].ax += fx / bodies[i].mass;
                    acc2[i].ay += fy / bodies[i].mass;
                    acc2[j].ax -= fx / bodies[j].mass;
                    acc2[j].ay -= fy / bodies[j].mass;
                }
            }

            // Complete velocity update with new accelerations
            for (let i = 0; i < n; i++) {
                bodies[i].vx += acc2[i].ax * dt / 2;
                bodies[i].vy += acc2[i].ay * dt / 2;

            }

            simTime += dt;
        }

        // ========================================
        // Rendering
        // ========================================
        function toScreen(x, y) {
            const W = canvas.getBoundingClientRect().width;
            const H = canvas.getBoundingClientRect().height;
            return {
                sx: W / 2 + panX + x * zoom,
                sy: H / 2 + panY - y * zoom
            };
        }

        function drawStars() {
            const W = canvas.getBoundingClientRect().width;
            const H = canvas.getBoundingClientRect().height;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            for (let i = 0; i < 100; i++) {
                const x = (i * 137.5 + 17) % W;
                const y = (i * 97.3 + 11) % H;
                ctx.beginPath();
                ctx.arc(x, y, 0.5 + (i % 3) * 0.3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawTrail(trail, color) {
            if (trail.length < 2) return;

            for (let i = 1; i < trail.length; i++) {
                const alpha = (i / trail.length) * 0.5;
                const p1 = toScreen(trail[i - 1].x, trail[i - 1].y);
                const p2 = toScreen(trail[i].x, trail[i].y);

                ctx.strokeStyle = color;
                ctx.globalAlpha = alpha;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(p1.sx, p1.sy);
                ctx.lineTo(p2.sx, p2.sy);
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
        }

        function drawBody(body, index) {
            const { sx, sy } = toScreen(body.x, body.y);
            // Ensure bodies don't disappear at low zoom
            const r = Math.max(2.5, body.radius * zoom);

            // Glow for stars
            if (body.isStar) {
                const glow = ctx.createRadialGradient(sx, sy, 0, sx, sy, r * 4);
                glow.addColorStop(0, body.color + 'cc');
                glow.addColorStop(0.3, body.color + '60');
                glow.addColorStop(1, 'transparent');
                ctx.beginPath();
                ctx.arc(sx, sy, r * 4, 0, Math.PI * 2);
                ctx.fillStyle = glow;
                ctx.fill();
            }

            // Body
            ctx.beginPath();
            ctx.arc(sx, sy, r, 0, Math.PI * 2);
            ctx.fillStyle = body.color;
            ctx.fill();

            // Velocity vector
            if (showVectors) {
                const vScale = 30 * zoom;
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(sx, sy);
                ctx.lineTo(sx + body.vx * vScale, sy - body.vy * vScale);
                ctx.stroke();
            }
        }

        function drawCentreOfMass() {
            if (!showCoM || bodies.length === 0) return;

            let totalMass = 0;
            let comX = 0, comY = 0;
            for (const b of bodies) {
                totalMass += b.mass;
                comX += b.x * b.mass;
                comY += b.y * b.mass;
            }
            comX /= totalMass;
            comY /= totalMass;

            const { sx, sy } = toScreen(comX, comY);

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(sx - 10, sy);
            ctx.lineTo(sx + 10, sy);
            ctx.moveTo(sx, sy - 10);
            ctx.lineTo(sx, sy + 10);
            ctx.stroke();
        }

        function render() {
            const W = canvas.getBoundingClientRect().width;
            const H = canvas.getBoundingClientRect().height;

            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, W, H);

            drawStars();

            for (let i = 0; i < bodies.length; i++) {
                drawTrail(trails[i], bodies[i].color);
            }

            drawCentreOfMass();

            for (let i = 0; i < bodies.length; i++) {
                drawBody(bodies[i], i);
            }

            document.getElementById('timeDisplay').textContent = simTime.toFixed(2);
        }

        // ========================================
        // Game Loop
        // ========================================
        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = Math.min((timestamp - lastTime) / 1000, 0.05);
            lastTime = timestamp;

            // FPS counter
            frameCount++;
            if (timestamp - lastFpsTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsTime = timestamp;
                document.getElementById('fpsDisplay').textContent = fps;
            }

            if (isPlaying) {
                const steps = 4;
                const subDt = deltaTime * timeScale * 20 / steps;
                for (let i = 0; i < steps; i++) {
                    updatePhysics(subDt);
                }

                // Update trails once per frame
                if (trailLength > 0) {
                    for (let i = 0; i < bodies.length; i++) {
                        trails[i].push({ x: bodies[i].x, y: bodies[i].y });
                        while (trails[i].length > trailLength) trails[i].shift();
                    }
                }
            }

            render();
            requestAnimationFrame(gameLoop);
        }

        // ========================================
        // Controls
        // ========================================
        function readControls() {
            N = parseInt(document.getElementById('nSlider').value);

            // Get masses from textbox inputs with unit conversion
            const centralDisplay = parseFloat(document.getElementById('centralInput').value) || 1;
            const centralUnit = document.getElementById('centralUnit').value;
            centralMass = displayToInternal(centralDisplay, centralUnit);

            const massDisplay = parseFloat(document.getElementById('massInput').value) || 1;
            const massUnit = document.getElementById('massUnit').value;
            particleMass = displayToInternal(massDisplay, massUnit);

            spread = parseFloat(document.getElementById('spreadSlider').value);
            timeScale = parseFloat(document.getElementById('speedSlider').value);
            trailLength = parseInt(document.getElementById('trailSlider').value);
            zoom = parseFloat(document.getElementById('zoomSlider').value);
            showVectors = document.getElementById('showVectors').checked;
            showCoM = document.getElementById('showCoM').checked;

            document.getElementById('nValue').textContent = N;
            document.getElementById('spreadValue').textContent = spread;
            document.getElementById('speedValue').textContent = timeScale.toFixed(2);
            document.getElementById('trailValue').textContent = trailLength;
            document.getElementById('zoomValue').textContent = zoom.toFixed(1);
        }

        // Initialize unit tracking
        document.getElementById('centralUnit').dataset.prevUnit = 'solar';
        document.getElementById('massUnit').dataset.prevUnit = 'earth';

        // Unit dropdown listeners
        ['centralUnit', 'massUnit'].forEach((id, index) => {
            const inputId = index === 0 ? 'centralInput' : 'massInput';
            document.getElementById(id).addEventListener('change', (e) => {
                const oldUnit = e.target.dataset.prevUnit || 'solar';
                const newUnit = e.target.value;
                const input = document.getElementById(inputId);
                const currentValue = parseFloat(input.value) || 1;
                input.value = convertUnits(currentValue, oldUnit, newUnit).toPrecision(4);
                e.target.dataset.prevUnit = newUnit;
                readControls();
                initSimulation();
            });
        });

        // Mass inputs
        ['centralInput', 'massInput'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                readControls();
                initSimulation();
            });
        });

        // Initial condition sliders - reset simulation
        ['nSlider', 'spreadSlider'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                readControls();
                initSimulation();
            });
        });

        // Display sliders - no reset needed
        ['speedSlider', 'trailSlider', 'zoomSlider'].forEach(id => {
            document.getElementById(id).addEventListener('input', readControls);
        });

        document.getElementById('showVectors').addEventListener('change', readControls);
        document.getElementById('showCoM').addEventListener('change', readControls);

        document.getElementById('playPauseBtn').addEventListener('click', () => {
            isPlaying = !isPlaying;
            document.getElementById('playPauseBtn').innerHTML = isPlaying
                ? '<i class="fas fa-pause"></i> Pause'
                : '<i class="fas fa-play"></i> Play';
        });

        document.getElementById('resetBtn').addEventListener('click', () => initSimulation());

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const presetName = btn.dataset.preset;

                initSimulation(presetName);
            });
        });

        // ========================================
        // Custom Placement Mode
        // ========================================


        // ========================================
        // Initialize
        // ========================================
        readControls();
        initSimulation('solar');
        requestAnimationFrame(gameLoop);
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Two-Body Simulation | Mitchell Hooymans</title>
    <meta name="description"
        content="Explore gravitational dynamics with this interactive two-body simulation. Watch two masses orbit their common centre of mass.">
    <link rel="canonical" href="https://mitchellhooymans.com/simulations/twobody.html" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mitchellhooymans.com/simulations/twobody.html">
    <meta property="og:title" content="Interactive Two-Body Simulation | Mitchell Hooymans">
    <meta property="og:description"
        content="Explore gravitational dynamics with this interactive two-body simulation. Watch two masses orbit their common centre of mass.">
    <meta property="og:image" content="https://mitchellhooymans.com/images/general/milkyway.jpg">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://mitchellhooymans.com/simulations/twobody.html">
    <meta name="twitter:title" content="Interactive Two-Body Simulation | Mitchell Hooymans">
    <meta name="twitter:description"
        content="Explore gravitational dynamics with this interactive two-body simulation. Watch two masses orbit their common centre of mass.">
    <meta name="twitter:image" content="https://mitchellhooymans.com/images/general/milkyway.jpg">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../styles.css">
    <link rel="shortcut icon" href="../images/favicon/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon/apple-touch-icon.png">
    <link rel="manifest" href="../images/favicon/site.webmanifest">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        .content-section {
            max-width: 1000px;
            margin: 0 auto;
        }

        .simulation-wrapper {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-6);
        }

        @media (min-width: 900px) {
            .simulation-wrapper {
                grid-template-columns: 1fr 300px;
            }
        }

        .simulation-container {
            background: #000;
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            width: 100%;
        }

        #simulationCanvas {
            display: block;
            width: 100%;
            height: 100%;
            aspect-ratio: 16/9;
            background: radial-gradient(ellipse at center, #0d1117 0%, #000 100%);
        }

        .sim-overlay {
            position: absolute;
            top: var(--space-3);
            left: var(--space-3);
            background: rgba(0, 0, 0, 0.7);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            color: #fff;
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
        }

        .sim-overlay div {
            margin-bottom: var(--space-1);
        }

        .controls-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
        }

        .controls-panel h3 {
            margin-bottom: var(--space-4);
            color: var(--color-white);
            font-size: 1rem;
        }

        .control-section {
            margin-bottom: var(--space-5);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
        }

        .control-section:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .control-section h4 {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-gray-400);
            margin-bottom: var(--space-3);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
            margin-bottom: var(--space-3);
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: var(--color-white);
            font-size: 0.85rem;
        }

        .control-value {
            font-weight: 600;
            color: var(--color-accent);
            font-size: 0.8rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--color-gray-300);
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            transition: background 0.2s;
        }

        .control-group input[type="range"]:hover {
            background: var(--color-gray-400);
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-accent);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .button-row {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .sim-btn {
            flex: 1;
            min-width: 80px;
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-1);
        }

        .sim-btn-primary {
            background: var(--color-accent);
            color: var(--color-white);
        }

        .sim-btn-primary:hover {
            background: #d4a853;
        }

        .sim-btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-white);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sim-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-white);
        }

        .info-card {
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
            color: var(--color-white);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .info-card h3 {
            color: var(--color-white);
            margin-bottom: var(--space-3);
            font-size: 1.1rem;
        }

        .info-card p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: var(--space-3);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .info-card p:last-child {
            margin-bottom: 0;
        }

        .legend {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-3);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.8rem;
            color: var(--color-gray-600);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .preset-btns {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            margin-bottom: var(--space-3);
        }

        .preset-btn {
            padding: var(--space-1) var(--space-3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-white);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .preset-btn:hover,
        .preset-btn.active {
            border-color: var(--color-accent);
            background: var(--color-accent);
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .placement-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            padding: var(--space-4);
            cursor: crosshair;
            z-index: 10;
        }

        .placement-overlay.hidden {
            display: none;
        }

        .placement-overlay i {
            font-size: 2rem;
            margin-bottom: var(--space-3);
            color: var(--color-accent);
        }

        .placement-count {
            margin-top: var(--space-2);
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .unit-label {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-left: 2px;
        }

        .mass-input-group {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        .mass-input {
            flex: 1;
            padding: var(--space-2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-white);
            background: rgba(0, 0, 0, 0.3);
            min-width: 0;
        }

        .mass-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2);
        }

        .unit-select {
            padding: var(--space-2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-white);
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            min-width: 70px;
        }

        .unit-select:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .control-group.mass-control label {
            margin-bottom: var(--space-1);
        }

        /* Full Browser Mode */
        body.full-browser {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        body.full-browser .nav,
        body.full-browser .page-header,
        body.full-browser .footer,
        body.full-browser .back-link,
        body.full-browser .info-card {
            display: none !important;
        }

        body.full-browser .section {
            padding: 0 !important;
            margin: 0 !important;
        }

        body.full-browser .container {
            max-width: none !important;
            width: 100vw !important;
            height: 100vh !important;
            padding: 0 !important;
        }

        body.full-browser .content-section {
            max-width: none !important;
            margin: 0 !important;
            height: 100% !important;
        }

        body.full-browser .simulation-wrapper {
            grid-template-columns: 1fr !important;
            height: 100% !important;
            gap: 0 !important;
        }

        body.full-browser .simulation-container {
            border-radius: 0 !important;
            height: 100% !important;
        }

        body.full-browser #simulationCanvas {
            aspect-ratio: auto !important;
            height: 100% !important;
        }

        body.full-browser .controls-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: var(--shadow-2xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.full-browser .sim-overlay {
            top: 20px;
            left: 20px;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <!-- Navigation -->
    <div id="navbar-placeholder"></div>
    <script src="../js/navbar.js"></script>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="../pages/about.html">About</a>
        <a href="../pages/tutorials.html">Tutorials</a>
        <a href="../pages/simulations.html">Simulations</a>
        <a href="../pages/blog.html">Blog</a>
        <a href="../pages/photography.html">Photography</a>
        <a href="../pages/cv.html">CV</a>
        <a href="../pages/contact.html">Contact</a>
    </div>

    <!-- Page Header -->
    <header class="page-header">
        <div class="container">
            <a href="../pages/simulations.html" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Simulations
            </a>
            <h1>Two-Body Simulation</h1>
            <p>Explore gravitational dynamics interactively</p>
        </div>
    </header>

    <!-- Main Content -->
    <section class="section">
        <div class="container">
            <a href="../pages/simulations.html" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Simulations
            </a>

            <div class="content-section">
                <!-- Info Card -->
                <div class="info-card">
                    <h3><i class="fas fa-star"></i> About This Simulation</h3>
                    <p>
                        Watch two bodies orbit their common <strong>centre of mass</strong> (marked with a +).
                        This is a top-down view of a gravitational system. Both bodies move — the heavier one
                        moves less, the lighter one moves more.
                    </p>
                    <p style="font-size: 0.85rem; opacity: 0.9;">
                        <strong>Units:</strong> Mass is measured in <em>solar masses</em> (M☉), where 1 M☉ = the mass of
                        our Sun
                        (≈ 2 × 10³⁰ kg). Distance is measured in <em>astronomical units</em> (AU), where 1 AU =
                        Earth-Sun distance
                        (≈ 150 million km).
                    </p>
                    <div class="legend">
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #fbbf24;"></span> Body 1 (Primary)
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #60a5fa;"></span> Body 2 (Secondary)
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #fff; border: 1px solid #666;"></span> Centre of
                            Mass
                        </div>
                    </div>
                </div>

                <div class="simulation-wrapper">
                    <!-- Simulation Canvas -->
                    <div class="simulation-container">
                        <canvas id="simulationCanvas"></canvas>
                        <div class="sim-overlay">
                            <div>Time: <span id="timeDisplay">0.00</span></div>
                            <div>Orbits: <span id="orbitCount">0</span></div>
                        </div>

                    </div>

                    <!-- Controls Panel -->
                    <div class="controls-panel">
                        <h3><i class="fas fa-sliders-h"></i> Controls</h3>

                        <div class="control-section">
                            <h4>Presets</h4>
                            <div class="preset-btns">
                                <button class="preset-btn" data-preset="earth-sun">Earth-Sun</button>
                                <button class="preset-btn" data-preset="binary-star">Binary Star</button>

                                <button class="preset-btn" data-preset="equal-mass">Equal Mass</button>

                            </div>
                        </div>

                        <div class="control-section">
                            <h4>Masses</h4>
                            <div class="control-group mass-control">
                                <label>Body 1 Mass</label>
                                <div class="mass-input-group">
                                    <input type="number" id="m1Input" class="mass-input" value="1" min="0" step="any">
                                    <select id="m1Unit" class="unit-select">
                                        <option value="solar" selected>M☉</option>
                                        <option value="earth">M⊕</option>
                                    </select>
                                </div>
                            </div>
                            <div class="control-group mass-control">
                                <label>Body 2 Mass</label>
                                <div class="mass-input-group">
                                    <input type="number" id="m2Input" class="mass-input" value="0.000003" min="0"
                                        step="any">
                                    <select id="m2Unit" class="unit-select">
                                        <option value="solar" selected>M☉</option>
                                        <option value="earth">M⊕</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="control-section">
                            <h4>Orbit</h4>
                            <div class="control-group">
                                <label>Separation <span class="control-value" id="sepValue">1.5</span><span
                                        class="unit-label">AU</span></label>
                                <input type="range" id="sepSlider" min="0.5" max="5" step="0.1" value="1.5">
                            </div>
                            <div class="control-group">
                                <label>Eccentricity <span class="control-value" id="eccValue">0.0</span></label>
                                <input type="range" id="eccSlider" min="0" max="0.8" step="0.05" value="0">
                            </div>
                        </div>



                        <div class="control-section">
                            <h4>Display</h4>
                            <div class="control-group">
                                <label>Speed <span class="control-value" id="speedValue">1.0x</span></label>
                                <input type="range" id="speedSlider" min="0.25" max="4" step="0.25" value="1">
                            </div>
                            <div class="control-group">
                                <label>Trail Length <span class="control-value" id="trailValue">300</span></label>
                                <input type="range" id="trailSlider" min="0" max="600" step="50" value="300">
                            </div>
                        </div>

                        <div class="button-row">
                            <button class="sim-btn sim-btn-primary" id="playPauseBtn">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button class="sim-btn sim-btn-secondary" id="resetBtn">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                        <button class="sim-btn sim-btn-secondary" id="fullBrowserBtn"
                            style="width: 100%; margin-top: var(--space-3);">
                            <i class="fas fa-expand"></i> Full Browser
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div>
                    <div class="footer-brand">Mitchell Hooymans</div>
                    <p class="footer-tagline">Astrophysicist & STEM Communicator</p>
                </div>
                <div class="social-links">
                    <a href="https://www.linkedin.com/in/mitchell-hooymans/" class="social-link" aria-label="LinkedIn"
                        target="_blank">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a href="https://github.com/mitchellhooymans" class="social-link" aria-label="GitHub"
                        target="_blank">
                        <i class="fab fa-github"></i>
                    </a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Mitchell Hooymans. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script>

        // ========================================
        // Simulation Setup
        // ========================================
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');

        // High-DPI scaling
        function setupCanvas() {
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.resetTransform();
            ctx.scale(dpr, dpr);
        }
        setupCanvas();
        window.addEventListener('resize', setupCanvas);

        // View State (Panning)
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        // Pan Event Listeners
        canvas.addEventListener('mousedown', (e) => {
            if (isCustomMode) return;
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - lastMouseX;
            const dy = e.clientY - lastMouseY;
            panX += dx;
            panY += dy;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            render();
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.style.cursor = isCustomMode ? 'crosshair' : 'grab';
        });

        canvas.addEventListener('dblclick', () => {
            if (isCustomMode) return;
            panX = 0;
            panY = 0;
            render();
        });

        // Initialize cursor
        canvas.style.cursor = 'grab';

        // Full Browser Logic
        document.getElementById('fullBrowserBtn').addEventListener('click', function () {
            document.body.classList.toggle('full-browser');
            const icon = this.querySelector('i');
            const text = this.lastChild;

            if (document.body.classList.contains('full-browser')) {
                icon.className = 'fas fa-compress';
                text.textContent = ' Exit Full';
            } else {
                icon.className = 'fas fa-expand';
                text.textContent = ' Full Browser';
            }

            setTimeout(setupCanvas, 50);
        });

        // ========================================
        // Simulation State
        // ========================================
        let isPlaying = true;
        let simTime = 0;
        let orbitCount = 0;
        let lastAngle = 0;

        // Parameters (from controls)
        let m1 = 10, m2 = 1;
        let separation = 1.5; // AU
        let eccentricity = 0;
        let timeScale = 1;
        let trailLength = 300;

        // Physics state
        let body1, body2;
        let trail1 = [], trail2 = [];

        // Custom placement mode
        let isCustomMode = false;
        let customBodies = [];
        const placementOverlay = document.getElementById('placementOverlay');

        // Scale: pixels per AU (visual scaling)
        const PIXELS_PER_AU = 100;

        // Gravitational constant (scaled for visual appearance)
        const G = 1000;

        // ========================================
        // Initialization
        // ========================================
        function toScreen(x, y) {
            const W = canvas.getBoundingClientRect().width;
            const H = canvas.getBoundingClientRect().height;
            const cx = W / 2 + panX;
            const cy = H / 2 + panY;
            return {
                sx: cx + x,
                sy: cy + y
            };
        }

        function initSimulation() {
            const totalMass = m1 + m2;

            // Convert AU to pixels
            const sepPx = separation * PIXELS_PER_AU;

            // Periapsis distance (closest approach) in pixels
            const rPeri = sepPx * (1 - eccentricity);

            // Distance of each body from centre of mass at periapsis
            const r1 = rPeri * m2 / totalMass;
            const r2 = rPeri * m1 / totalMass;

            // Orbital velocity at periapsis for the reduced mass system
            // v = sqrt(G * M * (1 + e) / rPeri)
            const vPeri = Math.sqrt(G * totalMass * (1 + eccentricity) / rPeri);

            // Velocities scaled by mass ratio (momentum conservation)
            const v1 = vPeri * m2 / totalMass;
            const v2 = vPeri * m1 / totalMass;

            body1 = {
                x: r1,
                y: 0,
                vx: 0,
                vy: -v1,
                mass: m1,
                radius: 8,
                color: '#fbbf24' // Amber
            };

            body2 = {
                x: -r2,
                y: 0,
                vx: 0,
                vy: v2,
                mass: m2,
                radius: 8,
                color: '#60a5fa' // Blue
            };

            trail1 = [];
            trail2 = [];
            simTime = 0;
            orbitCount = 0;
            lastAngle = Math.atan2(body2.y, body2.x);
        }

        // ========================================
        // Physics Update (Velocity Verlet)
        // ========================================
        function computeAcceleration(b1, b2) {
            const dx = b2.x - b1.x;
            const dy = b2.y - b1.y;
            const distSq = dx * dx + dy * dy;
            const dist = Math.sqrt(distSq);

            // Softening to prevent singularities
            const softDist = Math.max(dist, b1.radius + b2.radius);
            const softDistSq = softDist * softDist;

            const forceMag = G * b1.mass * b2.mass / softDistSq;

            return {
                ax1: (forceMag / b1.mass) * (dx / dist),
                ay1: (forceMag / b1.mass) * (dy / dist),
                ax2: -(forceMag / b2.mass) * (dx / dist),
                ay2: -(forceMag / b2.mass) * (dy / dist)
            };
        }

        function updatePhysics(dt) {
            // Velocity Verlet integration for stability
            const acc = computeAcceleration(body1, body2);

            // Half-step velocity update
            body1.vx += acc.ax1 * dt / 2;
            body1.vy += acc.ay1 * dt / 2;
            body2.vx += acc.ax2 * dt / 2;
            body2.vy += acc.ay2 * dt / 2;

            // Full-step position update
            body1.x += body1.vx * dt;
            body1.y += body1.vy * dt;
            body2.x += body2.vx * dt;
            body2.y += body2.vy * dt;

            // Recalculate acceleration at new position
            const acc2 = computeAcceleration(body1, body2);

            // Half-step velocity update with new acceleration
            body1.vx += acc2.ax1 * dt / 2;
            body1.vy += acc2.ay1 * dt / 2;
            body2.vx += acc2.ax2 * dt / 2;
            body2.vy += acc2.ay2 * dt / 2;

            // Record trails
            if (trailLength > 0) {
                trail1.push({ x: body1.x, y: body1.y });
                trail2.push({ x: body2.x, y: body2.y });
                while (trail1.length > trailLength) trail1.shift();
                while (trail2.length > trailLength) trail2.shift();
            }

            // Update time and orbit count
            simTime += dt / 60; // Approximate time unit

            // Update time and orbit count
            simTime += dt / 60; // Approximate time unit

            const angle = Math.atan2(body2.y, body2.x);

            // Detect orbit completion (crossing from -π to π)
            if (lastAngle < -2 && angle > 2) {
                orbitCount++;
            } else if (lastAngle > 2 && angle < -2) {
                orbitCount++;
            }
            lastAngle = angle;
        }

        // ========================================
        // Rendering
        // ========================================
        function drawStars() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            const W = canvas.getBoundingClientRect().width;
            const H = canvas.getBoundingClientRect().height;
            for (let i = 0; i < 80; i++) {
                const x = (i * 137.5 + 13) % W;
                const y = (i * 97.3 + 7) % H;
                const size = 0.5 + (i % 3) * 0.5;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawTrail(trail, color) {
            if (trail.length < 2) return;

            for (let i = 1; i < trail.length; i++) {
                const alpha = (i / trail.length) * 0.6;
                const p1 = toScreen(trail[i - 1].x, trail[i - 1].y);
                const p2 = toScreen(trail[i].x, trail[i].y);
                ctx.strokeStyle = color;
                ctx.globalAlpha = alpha;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(p1.sx, p1.sy);
                ctx.lineTo(p2.sx, p2.sy);
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
        }

        function drawBody(body) {
            const { sx, sy } = toScreen(body.x, body.y);
            // Glow
            const glow = ctx.createRadialGradient(
                sx, sy, 0,
                sx, sy, body.radius * 3
            );
            glow.addColorStop(0, body.color + 'aa');
            glow.addColorStop(0.5, body.color + '40');
            glow.addColorStop(1, 'transparent');

            ctx.beginPath();
            ctx.arc(sx, sy, body.radius * 3, 0, Math.PI * 2);
            ctx.fillStyle = glow;
            ctx.fill();

            // Solid body
            ctx.beginPath();
            ctx.arc(sx, sy, body.radius, 0, Math.PI * 2);
            ctx.fillStyle = body.color;
            ctx.fill();
        }

        function drawCentreOfMass() {
            const { sx, sy } = toScreen(0, 0);

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(sx - 8, sy);
            ctx.lineTo(sx + 8, sy);
            ctx.moveTo(sx, sy - 8);
            ctx.lineTo(sx, sy + 8);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(sx, sy, 3, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.fill();
        }

        function render() {
            const W = canvas.getBoundingClientRect().width;
            const H = canvas.getBoundingClientRect().height;

            // Clear
            ctx.fillStyle = '#0a0a14';
            ctx.fillRect(0, 0, W, H);

            drawStars();
            drawTrail(trail1, body1.color);
            drawTrail(trail2, body2.color);
            drawCentreOfMass();
            drawBody(body1);
            drawBody(body2);

            // Update display
            document.getElementById('timeDisplay').textContent = simTime.toFixed(2);
            document.getElementById('orbitCount').textContent = orbitCount;
        }

        // ========================================
        // Game Loop
        // ========================================
        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = Math.min((timestamp - lastTime) / 1000, 0.05);
            lastTime = timestamp;

            if (isPlaying) {
                // Multiple sub-steps for stability
                const steps = 4;
                const subDt = deltaTime * timeScale * 40 / steps;
                for (let i = 0; i < steps; i++) {
                    updatePhysics(subDt);
                }
            }

            render();
            requestAnimationFrame(gameLoop);
        }

        // ========================================
        // Controls & Unit Conversion
        // ========================================

        // Unit conversion constants (relative to solar mass)
        const UNIT_TO_SOLAR = {
            'solar': 1,
            'earth': 1 / 332946        // 1 Earth mass = 1/332946 solar masses
        };

        const SOLAR_TO_UNIT = {
            'solar': 1,
            'earth': 332946
        };

        // Internal mass unit scale (keeps simulation stable)
        const INTERNAL_MASS_SCALE = 10;  // 1 solar mass = 10 internal units

        // Convert display value to internal simulation mass
        function displayToInternal(value, unit) {
            const solarMass = value * UNIT_TO_SOLAR[unit];
            return solarMass * INTERNAL_MASS_SCALE;
        }

        // Convert internal simulation mass to display value
        function internalToDisplay(internalMass, unit) {
            const solarMass = internalMass / INTERNAL_MASS_SCALE;
            return solarMass * SOLAR_TO_UNIT[unit];
        }

        // Convert between display units
        function convertUnits(value, fromUnit, toUnit) {
            const solarMass = value * UNIT_TO_SOLAR[fromUnit];
            return solarMass * SOLAR_TO_UNIT[toUnit];
        }

        const m1Input = document.getElementById('m1Input');
        const m2Input = document.getElementById('m2Input');
        const m1UnitSelect = document.getElementById('m1Unit');
        const m2UnitSelect = document.getElementById('m2Unit');

        const sepSlider = document.getElementById('sepSlider');
        const eccSlider = document.getElementById('eccSlider');
        const speedSlider = document.getElementById('speedSlider');
        const trailSlider = document.getElementById('trailSlider');



        function updateFromControls(source) {
            // Get display values and convert to internal units - handle invalid/empty input
            const m1Val = m1Input.value;
            const m2Val = m2Input.value;

            const m1Display = (m1Val === "" || isNaN(parseFloat(m1Val))) ? 1 : Math.max(parseFloat(m1Val), 0.0001);
            const m2Display = (m2Val === "" || isNaN(parseFloat(m2Val))) ? 1 : Math.max(parseFloat(m2Val), 0.0001);

            const m1Unit = m1UnitSelect.value;
            const m2Unit = m2UnitSelect.value;

            m1 = displayToInternal(m1Display, m1Unit);
            m2 = displayToInternal(m2Display, m2Unit);

            separation = parseFloat(sepSlider.value);
            eccentricity = parseFloat(eccSlider.value);
            timeScale = parseFloat(speedSlider.value);
            trailLength = parseInt(trailSlider.value);

            // Compute velocities if not set manually
            if (false) { // DISABLED
                // Same logic as initSimulation to compute vPeri
                const totalMass = m1 + m2;
                const rPeri = (separation * PIXELS_PER_AU) * (1 - eccentricity);
                // Need to be careful with units here. G is 1000 in pixel/frame units. 
                // separation is AU. rPeri is pixels.
                // Wait, initSimulation uses G=1000. 
                // Let's replicate exact logic or just let initSimulation handle it?
                // The issue is updateFromControls is just for DISPLAYING the calculated v.

                // Let's use the same formula:
                // vPeri = sqrt(G * totalMass * (1 + eccentricity) / rPeri);
                const G = 1000;
                const PIXELS_PER_AU = 100;
                const rPeriPx = (separation * PIXELS_PER_AU) * (1 - eccentricity);

                if (rPeriPx > 0 && totalMass > 0) {
                    const vPeri = Math.sqrt(G * totalMass * (1 + eccentricity) / rPeriPx);
                    const vy1 = -(vPeri * m2 / totalMass);
                    const vy2 = vPeri * m1 / totalMass;

                    v1Input.value = vy1.toFixed(4);
                    v2Input.value = vy2.toFixed(4);
                }
            }

            document.getElementById('sepValue').textContent = separation;
            document.getElementById('eccValue').textContent = eccentricity.toFixed(2);
            document.getElementById('speedValue').textContent = timeScale.toFixed(2) + 'x';
            document.getElementById('trailValue').textContent = trailLength;
        }

        // Mass input event listeners - only re-init if value is valid and total mass > 0
        [m1Input, m2Input].forEach(input => {
            input.addEventListener('input', () => {
                const val = input.value;
                if (val !== "" && !isNaN(parseFloat(val))) {
                    const tempM1 = parseFloat(m1Input.value) || 0;
                    const tempM2 = parseFloat(m2Input.value) || 0;
                    if (tempM1 + tempM2 > 0) {
                        updateFromControls();
                        initSimulation();
                    }
                }
            });
        });



        // Unit dropdown listeners - convert existing value to new unit
        m1UnitSelect.addEventListener('change', (e) => {
            const oldUnit = e.target.dataset.prevUnit || 'solar';
            const newUnit = e.target.value;
            const currentValue = parseFloat(m1Input.value) || 0;
            m1Input.value = convertUnits(currentValue, oldUnit, newUnit).toPrecision(4);
            e.target.dataset.prevUnit = newUnit;
            updateFromControls();
            initSimulation();
        });

        m2UnitSelect.addEventListener('change', (e) => {
            const oldUnit = e.target.dataset.prevUnit || 'solar';
            const newUnit = e.target.value;
            const currentValue = parseFloat(m2Input.value) || 0;
            m2Input.value = convertUnits(currentValue, oldUnit, newUnit).toPrecision(4);
            e.target.dataset.prevUnit = newUnit;
            updateFromControls();
            initSimulation();
        });

        // Initialize previous unit tracking
        m1UnitSelect.dataset.prevUnit = 'solar';
        m2UnitSelect.dataset.prevUnit = 'solar';

        [sepSlider, eccSlider].forEach(slider => {
            slider.addEventListener('input', () => {
                updateFromControls();
                initSimulation();
            });
        });

        [speedSlider, trailSlider].forEach(slider => {
            slider.addEventListener('input', updateFromControls);
        });

        // Play/Pause
        document.getElementById('playPauseBtn').addEventListener('click', () => {
            isPlaying = !isPlaying;
            document.getElementById('playPauseBtn').innerHTML = isPlaying
                ? '<i class="fas fa-pause"></i> Pause'
                : '<i class="fas fa-play"></i> Play';
        });

        // Reset
        document.getElementById('resetBtn').addEventListener('click', initSimulation);

        // Presets with accurate physics values (in solar masses internally)
        // Displayed in appropriate units for each body
        const presets = {
            'earth-sun': {
                m1: 1, m1Unit: 'solar',           // Sun: 1 solar mass
                m2: 1, m2Unit: 'earth',           // Earth: 1 Earth mass (≈3×10⁻⁶ solar)
                sep: 1.0, ecc: 0.017
            },
            'binary-star': {
                m1: 1.5, m1Unit: 'solar',         // Star A: 1.5 solar masses
                m2: 1.2, m2Unit: 'solar',         // Star B: 1.2 solar masses
                sep: 1.5, ecc: 0.3
            },
            'earth-sun': {
                m1: 1, m1Unit: 'solar',           // Sun
                m2: 1, m2Unit: 'earth',           // Earth
                sep: 1, ecc: 0.017                // 1 AU, almost circular
            },
            'equal-mass': {
                m1: 1, m1Unit: 'solar',           // Equal solar-mass stars
                m2: 1, m2Unit: 'solar',
                sep: 1.6, ecc: 0
            }
        };

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Highlight active button
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const presetName = btn.dataset.preset;
                const p = presets[presetName];
                if (p) {
                    // Set mass values and units
                    m1Input.value = p.m1;
                    m1UnitSelect.value = p.m1Unit;
                    m1UnitSelect.dataset.prevUnit = p.m1Unit;

                    m2Input.value = p.m2;
                    m2UnitSelect.value = p.m2Unit;
                    m2UnitSelect.dataset.prevUnit = p.m2Unit;

                    sepSlider.value = p.sep;
                    eccSlider.value = p.ecc;
                    updateFromControls();
                    initSimulation();
                }
            });
        });

        // ========================================
        // Custom Placement Mode
        // ========================================


        // ========================================
        // Initialize
        // ========================================
        updateFromControls();
        updateFromControls();

        // Initialize with default preset
        const defaultPresetBtn = document.querySelector('.preset-btn[data-preset="earth-sun"]');
        if (defaultPresetBtn) {
            defaultPresetBtn.click();
        } else {
            initSimulation();
        }
        requestAnimationFrame(gameLoop);
    </script>
</body>

</html>